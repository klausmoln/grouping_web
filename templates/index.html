<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grouping for CGV München</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Grouping for CGV München</h1>

        <form id="add-form" class="mb-3">
            <div class="row g-3">
                <div class="col">
                    <input type="text" class="form-control" name="name" placeholder="姓名" required>
                </div>
                <div class="col">
                    <select class="form-select" name="gender" required>
                        <option value="" disabled selected>性别</option>
                        <option value="M">男</option>
                        <option value="F">女</option>
                    </select>
                </div>
                <div class="col">
                    <select class="form-select" name="location" required>
                        <option value="" disabled selected>地点</option>
                        <option value="On-site">线下</option>
                        <option value="Online">线上</option>
                    </select>
                </div>
                <div class="col">
                    <input type="text" class="form-control" name="spouse" placeholder="配偶姓名（可选）">
                </div>
                <div class="col">
                    <button type="submit" class="btn btn-primary">添加</button>
                </div>
            </div>
        </form>

        <h4>参与分组人员 (<span id="participating-count">{{ people|length }}</span>)</h4>
        <ul id="participating-list" class="list-group mb-3">
            {% for p in people %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ p.name }} ({{ p.gender }}) {% if p.location == "Online" %}*{% endif %}</span>
                <div>
                    {% if p.location == "Online" %}
                    <form method="post" action="/to_onsite" style="display: inline; margin-right: 5px;">
                        <input type="hidden" name="name" value="{{ p.name }}">
                        <button type="submit" class="btn btn-sm btn-info">转线下</button>
                    </form>
                    {% else %}
                    <form method="post" action="/to_online" style="display: inline; margin-right: 5px;">
                        <input type="hidden" name="name" value="{{ p.name }}">
                        <button type="submit" class="btn btn-sm btn-info">转线上</button>
                    </form>
                    {% endif %}
                    <form method="post" action="/withdraw" style="display: inline;">
                        <input type="hidden" name="name" value="{{ p.name }}">
                        <button type="submit" class="btn btn-sm btn-warning">退出分组</button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>

        <h4>不参与分组人员</h4>
        <ul id="not-participating-list" class="list-group mb-3">
            {% for p in not_participating %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ p.name }} ({{ p.gender }}) {% if p.location == "Online" %}*{% endif %}</span>
                <div>
                    {% if p.location == "Online" %}
                    <form method="post" action="/to_onsite" style="display: inline; margin-right: 5px;">
                        <input type="hidden" name="name" value="{{ p.name }}">
                        <button type="submit" class="btn btn-sm btn-info">转线下</button>
                    </form>
                    {% else %}
                    <form method="post" action="/to_online" style="display: inline; margin-right: 5px;">
                        <input type="hidden" name="name" value="{{ p.name }}">
                        <button type="submit" class="btn btn-sm btn-info">转线上</button>
                    </form>
                    {% endif %}
                    <form method="post" action="/join" style="display: inline;">
                        <input type="hidden" name="name" value="{{ p.name }}">
                        <button type="submit" class="btn btn-sm btn-success">加入分组</button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>

        <h4>分组</h4>
        <form id="group-form" class="mb-3">
            <div class="row g-3">
                <div class="col">
                    <input type="number" class="form-control" name="num_groups" value="3" placeholder="分组数量" required>
                </div>
                <div class="col">
                    <button type="submit" class="btn btn-success">开始分组</button>
                </div>
            </div>
        </form>
        <div id="group-result"></div>
    </div>

    <script>
        function updateLists(people, not_participating) {
            let participatingHtml = '';
            people.forEach(p => {
                participatingHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${p.name} (${p.gender}) ${p.location === "Online" ? '*' : ''}</span>
                    <div>
                        ${p.location === "Online" ? '<form method="post" action="/to_onsite" style="display: inline; margin-right: 5px;"><input type="hidden" name="name" value="' + p.name + '"><button type="submit" class="btn btn-sm btn-info">转线下</button></form>' : '<form method="post" action="/to_online" style="display: inline; margin-right: 5px;"><input type="hidden" name="name" value="' + p.name + '"><button type="submit" class="btn btn-sm btn-info">转线上</button></form>'}
                        <form method="post" action="/withdraw" style="display: inline;"><input type="hidden" name="name" value="' + p.name + '"><button type="submit" class="btn btn-sm btn-warning">退出分组</button></form>
                    </div>
                </li>`;
            });
            $('#participating-list').html(participatingHtml);

            let notParticipatingHtml = '';
            not_participating.forEach(p => {
                notParticipatingHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${p.name} (${p.gender}) ${p.location === "Online" ? '*' : ''}</span>
                    <div>
                        ${p.location === "Online" ? '<form method="post" action="/to_onsite" style="display: inline; margin-right: 5px;"><input type="hidden" name="name" value="' + p.name + '"><button type="submit" class="btn btn-sm btn-info">转线下</button></form>' : '<form method="post" action="/to_online" style="display: inline; margin-right: 5px;"><input type="hidden" name="name" value="' + p.name + '"><button type="submit" class="btn btn-sm btn-info">转线上</button></form>'}
                        <form method="post" action="/join" style="display: inline;"><input type="hidden" name="name" value="' + p.name + '"><button type="submit" class="btn btn-sm btn-success">加入分组</button></form>
                    </div>
                </li>`;
            });
            $('#not-participating-list').html(notParticipatingHtml);

            $('#participating-count').text(people.length);
        }

        $('#add-form').on('submit', function(e) {
            e.preventDefault();
            $.post('/add', $(this).serialize(), function(res) {
                if (res.success) {
                    updateLists(res.people, res.not_participating);
                    $(this)[0].reset();
                }
            });
        });

        $(document).on('submit', 'form[action="/withdraw"], form[action="/join"], form[action="/to_onsite"], form[action="/to_online"]', function(e) {
            e.preventDefault();
            let form = $(this);
            $.post(form.attr('action'), form.serialize(), function(res) {
                if (res.success) {
                    updateLists(res.people, res.not_participating);
                }
            });
        });

        $('#group-form').on('submit', function(e) {
            e.preventDefault();
            $.post('/group', $(this).serialize(), function(res) {
                if (res.groups) {
                    let html = '<h5>分组结果:</h5><ul class="list-group">';
                    res.groups.forEach((group, index) => {
                        html += `<li class="list-group-item">组 ${index + 1}: ${group.map(p => p.name + (p.location === "Online" ? '*' : '')).join(', ')}</li>`;
                    });
                    html += '</ul>';
                    $('#group-result').html(html);
                } else {
                    $('#group-result').html(`<div class="alert alert-danger">${res.error}</div>`);
                }
            });
        });
    </script>
</body>
</html>